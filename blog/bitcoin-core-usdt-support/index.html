<!doctype html><html lang=en><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=description content>
<title>Userspace, Statically Defined Tracing support for Bitcoin Core</title>
<meta property="og:title" content="Userspace, Statically Defined Tracing support for Bitcoin Core">
<meta property="og:description" content="This report updates on what 0xB10C, Coinbase Crypto Community Fund grant recipient,
has been working on over the first half of his year-long Bitcoin development grant.
This specifically covers his work on Userspace, Statically Defined Tracing support
for Bitcoin Core. This report was published on 0xB10Cs blog and the Coinbase blog too.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://bitcoin-dev.blog/blog/bitcoin-core-usdt-support/"><meta property="og:image" content="https://bitcoin-dev.blog/post-data/usdt-support-core/header.png"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2021-08-30T09:00:00+02:00">
<meta property="article:modified_time" content="2021-08-30T09:00:00+02:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://bitcoin-dev.blog/post-data/usdt-support-core/header.png">
<meta name=twitter:title content="Userspace, Statically Defined Tracing support for Bitcoin Core">
<meta name=twitter:description content="This report updates on what 0xB10C, Coinbase Crypto Community Fund grant recipient,
has been working on over the first half of his year-long Bitcoin development grant.
This specifically covers his work on Userspace, Statically Defined Tracing support
for Bitcoin Core. This report was published on 0xB10Cs blog and the Coinbase blog too.">
<meta name=twitter:site content="@bitcoindevblog">
<link rel=stylesheet href=/css/bootstrap.min.css integrity=sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC crossorigin=anonymous>
<link rel=stylesheet href=/css/syntax.css>
<link rel=stylesheet href=/css/index.css>
<link rel="shortcut icon" href=/favicon.png type=image/png>
<link rel=icon href=/favicon.png type=image/png>
<script async defer data-website-id=dfc2acc6-9237-4a34-bc2b-37967cb79a4c src=https://umami.b10c.me/b10c.js></script>
</head>
<body><nav class="navbar container rounded-bottom shadow-sm mb-4">
<a class=navbar-brand href=/>
<img src=/img/logo-large.png height=50 class="d-inline-block align-baseline image-to-invert mx-2" alt="bitcoin-dev blog logo">
<div class=d-inline-block>
<h1 class="d-block mb-0">bitcoin-dev blog</h1>
<h6 class="d-block mb-0" style="font-size:calc(.7rem + .7vw)">by and for Bitcoin developers</h6>
</div>
</a>
<div class=ml-auto>
<div class="form-check form-switch">
<input class=form-check-input type=checkbox id=light-dark-mode-switch>
<noscript>requires JS</noscript>
</div>
<script>var html,darkmodeSwitch;const MODE_KEY="mode";html=document.querySelector("html"),darkmodeSwitch=document.getElementById("light-dark-mode-switch");function set_dark_mode(){darkmodeSwitch.checked=!0,html.classList.add("dark"),html.classList.remove("light"),localStorage.setItem(MODE_KEY,!0)}function set_light_mode(){darkmodeSwitch.checked=!1,html.classList.add("light"),html.classList.remove("dark"),localStorage.setItem(MODE_KEY,!1)}let isModeStored=localStorage.getItem(MODE_KEY)!==null,perfersDarkmode=window.matchMedia('(prefers-color-scheme: dark)').matches;if(isModeStored){let a=localStorage.getItem(MODE_KEY)=="true";console.log("Dark-mode set to",a,"in localStorage."),a?set_dark_mode():set_light_mode()}else perfersDarkmode?(console.log("User prefers dark-mode."),set_dark_mode()):set_light_mode();darkmodeSwitch.addEventListener('change',a=>{a.currentTarget.checked?set_dark_mode():set_light_mode()})</script>
</div>
</nav>
<div id=content class=container>
<article class="card py-2 border-0 rounded shadow-sm">
<div class=card-body>
<div class="card-text px-lg-5 mx-lg-5 px-md-3 mx-md-3">
<header class="mt-lg-4 mb-3">
<span class=small>
</span>
<h2>
Userspace, Statically Defined Tracing support for Bitcoin Core
</h2>
<h5></h5>
<span>
published August 30, 2021
</span>
<span>
by
0xB10C
<a href=https://github.com/0xB10C class="mx-1 image-to-invert">
<img src=/img/footer/github.svg alt="link to @0xB10C on GitHub" height=18 class="d-inline-block align-text-top">
</a>
<a href=https://twitter.com/0xB10C class="mr-1 image-to-invert">
<img src=/img/footer/twitter.svg alt="link to @0xB10C on Twitter" height=18 class="d-inline-block align-text-top">
</a>
</span>
</br>
<span>
tagged with
<a href=/tags/bitcoin-core>Bitcoin Core</a>,
<a href=/tags/usdt-tracepoints>USDT tracepoints</a>
</span>
<br>
<span>
appeared first on <a href=https://b10c.me/blog/008-bitcoin-core-usdt-support/>b10c.me</a>
</span>
</header>
<hr>
<section class=content-text>
<p><em>This report updates on what 0xB10C, <a href=https://blog.coinbase.com/announcing-our-first-bitcoin-core-developer-grants-3d88559db068>Coinbase Crypto Community Fund grant recipient</a>,
has been working on over the first half of his year-long Bitcoin development grant.
This specifically covers his work on Userspace, Statically Defined Tracing support
for Bitcoin Core. This report was published on <a href=https://b10c.me/blog/008-bitcoin-core-usdt-support/>0xB10Cs blog</a> and the <a href=https://blog.coinbase.com/userspace-statically-defined-tracing-support-for-bitcoin-core-e4076cd3e07>Coinbase blog</a> too.</em></p>
<p>The reference implementation to the Bitcoin protocol rules, Bitcoin Core, is
the most widely used software to interact with the Bitcoin network. Bitcoin
Core is, however, a black box to most users. While information can be queried
via the RPC interface or searched in the debug log, there is no defined interface
for real-time insights into process internals. Yet, some users could benefit
from more observability into their node. Hobbyists and companies running Bitcoin
Core in production want to include their nodes in their real-time monitoring.
Developers need visibility into test deployments to evaluate, review, debug,
and benchmark changes. Researchers want to observe and analyze the behavior
of nodes on the peer-to-peer network. Exchanges and other services handling
large sums of bitcoin want to detect attacks and other anomalies early.</p>
<h3 id=peeking-inside-with-userspace-statically-defined-tracing>Peeking inside with Userspace, Statically Defined Tracing</h3>
<p>The <a href=https://ebpf.io>eBPF</a> technology present in the Linux kernel can be used for
observability into userspace applications. The technology allows
running a small, sandboxed program in the Linux kernel, which can hook
into predefined tracepoints in running processes. Once hooked into a
tracepoint, the program is executed each time the tracepoint is reached.
Tracepoints can pass data, for example, application state. Tracing scripts
can further process the data. The practice of hooking into tracepoints in
userspace applications is known as Userspace, Statically Defined Tracing
(USDT). For example, these tracepoints are also included in PostgreSQL,
MySQL, Python, NodeJS, Ruby, PHP, and libraries like libc, libpthread,
and libvirt.</p>
<p>The static tracepoints can be leveraged by Bitcoin Core users wishing for
more insights into their node. Adding USDT support <a href=https://github.com/bitcoin/bitcoin/pull/19866>did not require intrusive
changes</a>, and no custom tooling had to be written. When not used, the performance
impact of the tracepoints is minimal to non-existent. Only privileged processes
can hook into the tracepoints, no information leaks to other processes on the host.
These properties make Userspace, Statically Defined Tracing a good fit for Bitcoin
Core.</p>
<p>For example, I <a href=https://github.com/bitcoin/bitcoin/commit/4224dec22baa66547303840707cf1d4f15a49b20>placed two tracepoints</a> in the peer-to-peer message handling
code of Bitcoin Core. For each inbound and outbound P2P message, the tracepoints
pass information about the peer, the connection, and the message. This data can
be filtered and processed by tracing scripts. As a demo, I have built a P2P Monitor
that shows the communication between two peers in real-time. Users can find this
script alongside other <a href=https://github.com/bitcoin/bitcoin/tree/master/contrib/tracing>USDT examples</a> in the <code>contrib/tracing/</code> directory of the
Bitcoin Core repository.</p>
<blockquote class=twitter-tweet data-dnt=true><p lang=en dir=ltr>Realtime Bitcoin Core P2P monitoring with User-Space, Statically Defined Tracing (USDT) and eBPF.<br><br>This is one of the examples from <a href=https://t.co/1QGb7jgsnZ>https://t.co/1QGb7jgsnZ</a> (with added IP masking). <a href=https://t.co/E5mREYknEm>pic.twitter.com/E5mREYknEm</a></p>&mdash; 0xB10C (@0xB10C) <a href="https://twitter.com/0xB10C/status/1396889721859715077?ref_src=twsrc%5Etfw">May 24, 2021</a></blockquote>
<script async src=https://platform.twitter.com/widgets.js></script>
<h3 id=use-cases-for-userspace-statically-defined-tracing>Use-cases for Userspace, Statically Defined Tracing</h3>
<p>I list some use-cases for Userspace, Statically Defined Tracing
I have thought about or worked on. With only three tracepoints merged,
there is plenty of room for developers to add new tracepoints and
get creative with tracing scripts. <a href=https://github.com/bitcoin/bitcoin/issues/20981>Issue #20981</a> contains discussion
and ideas for additional tracepoints that can be implemented.</p>
<p>Researchers and developers can use the P2P message tracepoints to
monitor P2P network anomalies in real-time. One example could be
detecting the recent <code>addr</code> message flooding as reported in this
<a href="https://bitcointalk.org/index.php?topic=5348856.0">bitcointalk.org post</a>. The messages were announcing random IP
addresses not belonging to nodes on the Bitcoin network. The flooding
has been <a href=https://arxiv.org/abs/2108.00815>covered</a> in detail by Grundmann and Baumstark. They
discuss that the attacker could obtain the number of connected peers and
learn about other addresses, including Tor addresses, the node is listening
on. This would reduce the privacy of the node operator. It&rsquo;s important to
stay vigilant to these attacks, discuss them, and then, if needed, react
to them.</p>
<p>Similarly, I have been instrumenting the Bitcoin Core network address manager
with tracepoints. The addrman keeps track of gossiped network addresses for
potential outbound peers connections a node makes. It&rsquo;s designed to be resiliant
against <a href=https://cs-people.bu.edu/heilman/eclipse/>Eclipse Attacks</a>, where a node only has connections to peers controlled
by the attacker. The attacker can choose which information to feed to the node,
enabling, for example, double-spending attacks. Information about the addresses
in the addrman might help detect the build-up of an eclipse attack when combined
with other data.</p>
<p>Additionally, these addrman tracepoints can be helpful during debugging and
code review. To showcase this, I build a tool that visualizes the addresses
in the addrman data structure based on the data submitted to the tracepoints.</p>
<blockquote class=twitter-tweet data-dnt=true><p lang=en dir=ltr>Quiz: Which Bitcoin Core data-structure does this visualization show? <a href=https://t.co/U6cnHBFWWT>pic.twitter.com/U6cnHBFWWT</a></p>&mdash; 0xB10C (@0xB10C) <a href="https://twitter.com/0xB10C/status/1407019872681332742?ref_src=twsrc%5Etfw">June 21, 2021</a></blockquote>
<script async src=https://platform.twitter.com/widgets.js></script>
<p>A Prometheus metric exporter can also build on top of the tracepoints
without requiring additional code in Bitcoin Core. There already exist
RPC-based Prometheus exporters and projects like <a href=https://statoshi.info/>Statoshi</a>. However,
RPC-based exporters are limited by the information exposed via the RPC
interface, and Statoshi is large a patch-set that requires maintenance
on each Bitcoin Core release. I have published an experimental USDT-based
exporter called <a href=https://github.com/0xb10c/bitcoind-observer>bitcoind-observer</a> that hooks into the three currently
merged tracepoints and serves metrics in the Prometheus format. The exporter
can be used by everyone currently running a Bitcoin Core node compiled with
USDT support. A demo is available on <a href=https://bitcoind.observer>bitcoind.observer</a>. I&rsquo;ve recently used
this to benchmark the bandwidth usage of <a href=https://github.com/bitcoin/bitcoin/pull/21515>an implementation</a> of <a href=https://arxiv.org/abs/1905.10518>Erlay:
Bandwidth-Efficient Transaction Relay for Bitcoin</a>. Initial results can be
found <a href=https://github.com/naumenkogs/txrelaysim/issues/8#issuecomment-903255752>here</a>.</p>
<p>The already existing tracepoint <code>validation:block_connected</code> can be used
to benchmarking block validation. This allows, for example, to compare
the initial block download performance between different patches and can
aid in detecting performance improvements and regressions. For example,
the <a href=https://github.com/chaincodelabs/bitcoinperf>bitcoinperf</a> project might benefit from such tracepoints. I&rsquo;ve used
the tracepoint to <a href=https://github.com/bitcoin/bitcoin/pull/22702#issuecomment-900662089>benchmark</a> Martin Ankerls pull request <a href=https://github.com/bitcoin/bitcoin/pull/22702>#22702</a>. If
merged, the changes he proposes would result in a substantial block
validation speed up and reduction in memory usage.</p>
<h3 id=next-steps>Next steps</h3>
<p>I will collect further ideas for tracepoints and implement them alongside
example tracing scripts and more tooling. This will also involve
communicating with other Bitcoin and Bitcoin Core developers about
which tracepoints could be helpful in their projects. An example is
Antoine Riard&rsquo;s <a href=https://github.com/bitcoin/bitcoin/pull/18987>cross-layer anomaly detection watchdog</a> which he
initially proposed as a new, internal module to Bitcoin Core. However,
many of the required events and metrics can be collected by hooking into
tracepoints. This means the watchdog could be an external runtime, which
would speed up the watchdog development and requires less code and
maintenance on the Bitcoin Core side.</p>
<p>If everything goes according to plan, the v23.0 release of Bitcoin Core,
expected in early 2022, will include the first set of tracepoints. A
goal is to enable USDT support in release builds by default, which still needs
some work. Additionally, the tracepoint API should be semi-stable and thus
needs testing.</p>
<hr>
<p><strong>In short</strong>: I have been adding tracepoints to Bitcoin Core that users can hook
into to get insights into the internal state. The tracepoints are based on Linux
kernel technology and do not require intrusive changes or custom tooling. The
groundwork is done. Now further tracepoints can be added, and tooling can be written.</p>
</section>
<section>
<noscript>
<div class="alert alert-warning" role=alert>
Enable JavaScript to view comments.
Comments are hosted on GitHub with <a href=https://utteranc.es/>utteranc.es</a>.
</div>
</noscript>
<script src=https://utteranc.es/client.js repo=dev-bitcoin/blog-comments issue-term=title label=Comments theme=preferred-color-scheme crossorigin=anonymous async></script>
</section>
<section class="text-muted small">
All text and images in this work are licensed under a <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Attribution-ShareAlike 4.0 International License</a>
<a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-sa/4.0/80x15.png></a>
</section>
</div>
</div>
</article>
<section>
<div class=row>
<div class=col-lg>
<h4 class=mt-4>Next</h4>
<div class="card mb-4 border-0 rounded shadow-sm">
<div class="row row-cols-1 row-cols-md-2">
<div class="col col-md-4">
<img src=/post-data/compact-block-filters/cover.png style=object-fit:cover;height:100% class="card-img shadow-sm rounded" alt="Image for Compact Block Filters Deep Dive (BIP 158)">
<a class="stretched-link umami--click--card-img-compact-block-filters-deep-dive-bip-158" href=/blog/bip158-deep-dive/></a>
</div>
<div class="col col-md-8">
<div class=card-body>
<h4 class=card-title>Compact Block Filters Deep Dive (BIP 158)
</h4>
<p class=card-text>
In this post, I will briefly describe the needs of a bitcoin light client and why compact block filters satisfy these needs better than Bloom filters do. Then I will dive into exactly how compact block filters work and will follow this with a step-by-step guide for constructing such a filter from a …
</p>
</div>
<a class="stretched-link umami--click--card-text-compact-block-filters-deep-dive-bip-158" href=/blog/bip158-deep-dive/></a>
</div>
</div>
</div>
</div>
</div>
</section>
</div><footer class="container text-center my-3">
<div class=my-3>
<a rel=me href=https://twitter.com/bitcoindevblog class="m-2 image-to-invert umami--click--footer-twitter">
<img src=/img/footer/twitter.svg alt="logo twitter" height=32px>
</a>
<a rel=me href=https://github.com/dev-bitcoin class="m-2 image-to-invert umami--click--footer-github">
<img src=/img/footer/github.svg alt="logo github" height=32px>
</a>
<a href=/feed.xml class="m-2 image-to-invert umami--click--footer-rss-feed">
<img src=/img/footer/rss.svg alt="logo rss" height=32px>
</a>
<a href=mailto:contact[at]bitcoin-dev.blog class="m-2 image-to-invert umami--click--footer-gmail">
<img src=/img/footer/gmail.svg alt="logo mail" height=32px>
</a>
</div>
<span class="small text-muted">
This page uses a self-hosted <a href=https://umami.is class=umami--click--footer-umamiis>umami.is</a> instance as privacy-friendly visitor counter.
The statistics are pubicly accessible <a href=https://umami.b10c.me/share/hwUBMhXc/bitcoin-dev-blog class=umami--click--footer-stats>here</a>.
</span>
</footer>
</body>
</html>